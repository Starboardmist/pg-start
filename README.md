# Консольное приложение по установке PostgreSQL на наименее загруженный сервер

---

Скрипт устанавливает на одном из двух указанных по IP-адресам целевых серверов PostgreSQL и для проверки работоспособности выполняет простой SQL запрос SELECT 1.

---

## Что делает скрипт
Принимает от пользователя два IP-адреса.

Проверяет корректность IP-адресов.

Создает файл inventory.ini для Ansible.

Запускает playbook.

Если playbook выполняется успешно — выполняет SQL-запрос SELECT 1 в временной базе данных SQLite.

---
## Зависимости
- Python 3.x

- Установленный Ansible [core 2.16.3]

- psycopg2

- НЕ ОБЯЗАТЕЛЬНО. Установка зеркала от Яндекс-клауд. Требуются в случае создания ВМ через Terraform с конфигурациями приложенными к заданию
https://hashicorp-releases.yandexcloud.net/terraform/1.11.4/terraform_1.11.4_darwin_amd64.zip

---

## Инструкция по запуску
Инструкция по развертыванию с использованием скрипта и Ansible playbook

1. Клонировать репозиторий: Скопируйте проект с GitHub.

    git clone https://github.com/Starboardmist/pgstart.git

2*. НЕ ОБЯЗАТЕЛЬНО. Также возможно создание двух виртуальных мамшин через Terraform, настроенный под Yandex-Cloud. Соответственно установить переменные для окружения Yandex-Cloud.
    
    1. Для этого настроить переменные окружения: Откройте файл terraform.tfvars и замените значения по умолчанию на актуальные для вашей среды.

    2. Затем проверьте, что у вас установлен terraform:

        terraform --version

    3. Инициализировать terraform: Подготовьте рабочее окружение terraform, скачав необходимые плагины и модули.

        terraform init

    4. Применить конфигурацию terraform: Запустите процесс создания или обновления инфраструктуры согласно конфигурации:

        terraform apply -auto-approve

    5. Скопируйте полученные IP-адреса

3. Запустите скрипт Install-Postgresql.py

    python3 Install-Postgresql.py

4. Вставьте два IP-адреса, через запятую БЕЗ пробела.

5. Укажите путь до приватного ключа, с помощью которого происходит подключение к серверам.

5. Следите за ходом выполнения скрипта.

---

## Ход выполнения задачи
1. Декомпозировал задачу, расставив приоритеты и последовательность.

2. Для более быстрой проверки написанных в playbook задач, написал terraform скрипт, чтобы он поднимал 2 сервера, с минимальными системными характеристиками, прерываемые для экономии бюджета, на CentOS и Debian. Проверил работоспособность серверов.

3. Выбрал уже существующую роль geerlingguy.postgesql как одну из самых популярных для PostgeSQL.

4. В Ansible Playbook для начала написал задачу, которая определяет загруженность указанных серверов по loadavg['1m'], так как нагрузка за 1 минуту показывает что сервер прямо сейчас простаивает. И добавил получившиеся значения в словарь, для сравнения.

5. Написал отдельную задачу по сравнению нагрузки на двух серверах. Наименее нагруженный сервер добавляется в отдельную группу [evaluated_server] для установки на него PostgreSQL. IP-адрес второго сервера добавляется в глобальную перемменную, так как в дальнейшем пользователь student должен иметь возможность подключаться к базе данных только со второго сервера, на который не устанавливается PostgreSQL.

6. Затем написал отдельную задачу по конфигурации PostgreSQL на выбранный сервер с применением выбранной роли. Внёс все необходимые изменения, которые требуются для выполнения задачи с указанными условиями.

7. Убедился в правильной работоспособности playbook, после выполнения которого, подключался по ssh к серверам и выполнял простые sql запросы, также отдельно проверил что пользователь student может подключиться только со второго сервера.

8. Далее написал скрипт на Python, который запрашивает и проверяет правильность ввода IP-адресов, создает inventory.ini файл, требуемый в дальнейшемм для выполнения playbook. Этот же скрипт запускает playbook и в конце, в случае успешного выполнения, запускает sql запрос (SELECT 1).

9. Для вашего удобства проверки выполненного задания, решил оставить конфигурацию terraform,  для создания ВМ на базе Yandex-Cloud. Инструкцию по созданию ВМ прописана.

10. В конце проделанной работы, написал README файл, с указанием зависимостей и инструкцией по установке и проверки задачи.

11. В моем Ansible часть переменных указана прямо в скрипте, что является не очень хорошей практикой, есть понимание что это надо выводить в отдельные переменные. Банально в связи с нагрузкой, работой не успел всё сделать по красоте.

---

## Данные для удаленного подключения

По заданию созданы 2 пользователя:

- user: student password: 54321 # Имеет возможность удаленного подключения только со второго сервера

- user: timur password: 12345   # Имеет возможность подключаться к целевому серверу с абсолютно любого хоста